{
  "cells": [
    {
      "cell_type": "markdown",
      "metadata": {
        "id": "view-in-github",
        "colab_type": "text"
      },
      "source": [
        "<a href=\"https://colab.research.google.com/github/Adzium1/structural-antibody-binding-gnn/blob/main/src/gnn\" target=\"_parent\"><img src=\"https://colab.research.google.com/assets/colab-badge.svg\" alt=\"Open In Colab\"/></a>"
      ]
    },
    {
      "cell_type": "code",
      "source": [
        "!git clone https://github.com/Adzium1/structural-antibody-binding-gnn.git"
      ],
      "metadata": {
        "colab": {
          "base_uri": "https://localhost:8080/"
        },
        "id": "fE25wJ9Obq3l",
        "outputId": "6ee61cfe-1d6f-40ce-93a5-9388ec646941"
      },
      "execution_count": 7,
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": [
            "Cloning into 'structural-antibody-binding-gnn'...\n",
            "remote: Enumerating objects: 191, done.\u001b[K\n",
            "remote: Counting objects: 100% (191/191), done.\u001b[K\n",
            "remote: Compressing objects: 100% (147/147), done.\u001b[K\n",
            "remote: Total 191 (delta 65), reused 160 (delta 37), pack-reused 0 (from 0)\u001b[K\n",
            "Receiving objects: 100% (191/191), 6.04 MiB | 14.19 MiB/s, done.\n",
            "Resolving deltas: 100% (65/65), done.\n"
          ]
        }
      ]
    },
    {
      "cell_type": "code",
      "source": [
        "%cd structural-antibody-binding-gnn"
      ],
      "metadata": {
        "colab": {
          "base_uri": "https://localhost:8080/"
        },
        "id": "gk2oaYJibtsN",
        "outputId": "1d109eb9-48dd-465f-f5ce-7a64a77a1498"
      },
      "execution_count": 8,
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": [
            "/content/structural-antibody-binding-gnn\n"
          ]
        }
      ]
    },
    {
      "cell_type": "code",
      "source": [
        "!pip install -r requirements.txt\n"
      ],
      "metadata": {
        "colab": {
          "base_uri": "https://localhost:8080/"
        },
        "id": "rnjEe-0dbwDf",
        "outputId": "2a241a5a-0784-4057-bb91-bfc71e564b65"
      },
      "execution_count": 9,
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": [
            "Requirement already satisfied: numpy in /usr/local/lib/python3.12/dist-packages (from -r requirements.txt (line 1)) (2.0.2)\n",
            "Requirement already satisfied: pandas in /usr/local/lib/python3.12/dist-packages (from -r requirements.txt (line 2)) (2.2.2)\n",
            "Requirement already satisfied: matplotlib in /usr/local/lib/python3.12/dist-packages (from -r requirements.txt (line 3)) (3.10.0)\n",
            "Requirement already satisfied: seaborn in /usr/local/lib/python3.12/dist-packages (from -r requirements.txt (line 4)) (0.13.2)\n",
            "Requirement already satisfied: scikit-learn in /usr/local/lib/python3.12/dist-packages (from -r requirements.txt (line 5)) (1.6.1)\n",
            "Requirement already satisfied: xgboost in /usr/local/lib/python3.12/dist-packages (from -r requirements.txt (line 6)) (3.1.2)\n",
            "Collecting biopython (from -r requirements.txt (line 7))\n",
            "  Downloading biopython-1.86-cp312-cp312-manylinux2014_x86_64.manylinux_2_17_x86_64.manylinux_2_28_x86_64.whl.metadata (13 kB)\n",
            "Requirement already satisfied: torch in /usr/local/lib/python3.12/dist-packages (from -r requirements.txt (line 8)) (2.9.0+cu126)\n",
            "Requirement already satisfied: python-dateutil>=2.8.2 in /usr/local/lib/python3.12/dist-packages (from pandas->-r requirements.txt (line 2)) (2.9.0.post0)\n",
            "Requirement already satisfied: pytz>=2020.1 in /usr/local/lib/python3.12/dist-packages (from pandas->-r requirements.txt (line 2)) (2025.2)\n",
            "Requirement already satisfied: tzdata>=2022.7 in /usr/local/lib/python3.12/dist-packages (from pandas->-r requirements.txt (line 2)) (2025.3)\n",
            "Requirement already satisfied: contourpy>=1.0.1 in /usr/local/lib/python3.12/dist-packages (from matplotlib->-r requirements.txt (line 3)) (1.3.3)\n",
            "Requirement already satisfied: cycler>=0.10 in /usr/local/lib/python3.12/dist-packages (from matplotlib->-r requirements.txt (line 3)) (0.12.1)\n",
            "Requirement already satisfied: fonttools>=4.22.0 in /usr/local/lib/python3.12/dist-packages (from matplotlib->-r requirements.txt (line 3)) (4.61.1)\n",
            "Requirement already satisfied: kiwisolver>=1.3.1 in /usr/local/lib/python3.12/dist-packages (from matplotlib->-r requirements.txt (line 3)) (1.4.9)\n",
            "Requirement already satisfied: packaging>=20.0 in /usr/local/lib/python3.12/dist-packages (from matplotlib->-r requirements.txt (line 3)) (25.0)\n",
            "Requirement already satisfied: pillow>=8 in /usr/local/lib/python3.12/dist-packages (from matplotlib->-r requirements.txt (line 3)) (11.3.0)\n",
            "Requirement already satisfied: pyparsing>=2.3.1 in /usr/local/lib/python3.12/dist-packages (from matplotlib->-r requirements.txt (line 3)) (3.2.5)\n",
            "Requirement already satisfied: scipy>=1.6.0 in /usr/local/lib/python3.12/dist-packages (from scikit-learn->-r requirements.txt (line 5)) (1.16.3)\n",
            "Requirement already satisfied: joblib>=1.2.0 in /usr/local/lib/python3.12/dist-packages (from scikit-learn->-r requirements.txt (line 5)) (1.5.3)\n",
            "Requirement already satisfied: threadpoolctl>=3.1.0 in /usr/local/lib/python3.12/dist-packages (from scikit-learn->-r requirements.txt (line 5)) (3.6.0)\n",
            "Requirement already satisfied: nvidia-nccl-cu12 in /usr/local/lib/python3.12/dist-packages (from xgboost->-r requirements.txt (line 6)) (2.27.5)\n",
            "Requirement already satisfied: filelock in /usr/local/lib/python3.12/dist-packages (from torch->-r requirements.txt (line 8)) (3.20.0)\n",
            "Requirement already satisfied: typing-extensions>=4.10.0 in /usr/local/lib/python3.12/dist-packages (from torch->-r requirements.txt (line 8)) (4.15.0)\n",
            "Requirement already satisfied: setuptools in /usr/local/lib/python3.12/dist-packages (from torch->-r requirements.txt (line 8)) (75.2.0)\n",
            "Requirement already satisfied: sympy>=1.13.3 in /usr/local/lib/python3.12/dist-packages (from torch->-r requirements.txt (line 8)) (1.14.0)\n",
            "Requirement already satisfied: networkx>=2.5.1 in /usr/local/lib/python3.12/dist-packages (from torch->-r requirements.txt (line 8)) (3.6.1)\n",
            "Requirement already satisfied: jinja2 in /usr/local/lib/python3.12/dist-packages (from torch->-r requirements.txt (line 8)) (3.1.6)\n",
            "Requirement already satisfied: fsspec>=0.8.5 in /usr/local/lib/python3.12/dist-packages (from torch->-r requirements.txt (line 8)) (2025.3.0)\n",
            "Requirement already satisfied: nvidia-cuda-nvrtc-cu12==12.6.77 in /usr/local/lib/python3.12/dist-packages (from torch->-r requirements.txt (line 8)) (12.6.77)\n",
            "Requirement already satisfied: nvidia-cuda-runtime-cu12==12.6.77 in /usr/local/lib/python3.12/dist-packages (from torch->-r requirements.txt (line 8)) (12.6.77)\n",
            "Requirement already satisfied: nvidia-cuda-cupti-cu12==12.6.80 in /usr/local/lib/python3.12/dist-packages (from torch->-r requirements.txt (line 8)) (12.6.80)\n",
            "Requirement already satisfied: nvidia-cudnn-cu12==9.10.2.21 in /usr/local/lib/python3.12/dist-packages (from torch->-r requirements.txt (line 8)) (9.10.2.21)\n",
            "Requirement already satisfied: nvidia-cublas-cu12==12.6.4.1 in /usr/local/lib/python3.12/dist-packages (from torch->-r requirements.txt (line 8)) (12.6.4.1)\n",
            "Requirement already satisfied: nvidia-cufft-cu12==11.3.0.4 in /usr/local/lib/python3.12/dist-packages (from torch->-r requirements.txt (line 8)) (11.3.0.4)\n",
            "Requirement already satisfied: nvidia-curand-cu12==10.3.7.77 in /usr/local/lib/python3.12/dist-packages (from torch->-r requirements.txt (line 8)) (10.3.7.77)\n",
            "Requirement already satisfied: nvidia-cusolver-cu12==11.7.1.2 in /usr/local/lib/python3.12/dist-packages (from torch->-r requirements.txt (line 8)) (11.7.1.2)\n",
            "Requirement already satisfied: nvidia-cusparse-cu12==12.5.4.2 in /usr/local/lib/python3.12/dist-packages (from torch->-r requirements.txt (line 8)) (12.5.4.2)\n",
            "Requirement already satisfied: nvidia-cusparselt-cu12==0.7.1 in /usr/local/lib/python3.12/dist-packages (from torch->-r requirements.txt (line 8)) (0.7.1)\n",
            "Requirement already satisfied: nvidia-nvshmem-cu12==3.3.20 in /usr/local/lib/python3.12/dist-packages (from torch->-r requirements.txt (line 8)) (3.3.20)\n",
            "Requirement already satisfied: nvidia-nvtx-cu12==12.6.77 in /usr/local/lib/python3.12/dist-packages (from torch->-r requirements.txt (line 8)) (12.6.77)\n",
            "Requirement already satisfied: nvidia-nvjitlink-cu12==12.6.85 in /usr/local/lib/python3.12/dist-packages (from torch->-r requirements.txt (line 8)) (12.6.85)\n",
            "Requirement already satisfied: nvidia-cufile-cu12==1.11.1.6 in /usr/local/lib/python3.12/dist-packages (from torch->-r requirements.txt (line 8)) (1.11.1.6)\n",
            "Requirement already satisfied: triton==3.5.0 in /usr/local/lib/python3.12/dist-packages (from torch->-r requirements.txt (line 8)) (3.5.0)\n",
            "Requirement already satisfied: six>=1.5 in /usr/local/lib/python3.12/dist-packages (from python-dateutil>=2.8.2->pandas->-r requirements.txt (line 2)) (1.17.0)\n",
            "Requirement already satisfied: mpmath<1.4,>=1.1.0 in /usr/local/lib/python3.12/dist-packages (from sympy>=1.13.3->torch->-r requirements.txt (line 8)) (1.3.0)\n",
            "Requirement already satisfied: MarkupSafe>=2.0 in /usr/local/lib/python3.12/dist-packages (from jinja2->torch->-r requirements.txt (line 8)) (3.0.3)\n",
            "Downloading biopython-1.86-cp312-cp312-manylinux2014_x86_64.manylinux_2_17_x86_64.manylinux_2_28_x86_64.whl (3.2 MB)\n",
            "\u001b[2K   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m3.2/3.2 MB\u001b[0m \u001b[31m55.2 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\n",
            "\u001b[?25hInstalling collected packages: biopython\n",
            "Successfully installed biopython-1.86\n"
          ]
        }
      ]
    },
    {
      "cell_type": "code",
      "source": [
        "%cd /content/structural-antibody-binding-gnn"
      ],
      "metadata": {
        "colab": {
          "base_uri": "https://localhost:8080/"
        },
        "id": "jKcHmJdtbyV8",
        "outputId": "36e87698-3252-4bf0-d546-bc9049afe5fb"
      },
      "execution_count": 10,
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": [
            "/content/structural-antibody-binding-gnn\n"
          ]
        }
      ]
    },
    {
      "cell_type": "code",
      "source": [
        "import src.gnn.train_gnn as tg\n",
        "print(dir(tg))"
      ],
      "metadata": {
        "colab": {
          "base_uri": "https://localhost:8080/"
        },
        "id": "hJL5CPRQhl04",
        "outputId": "45368ff4-83b0-4a90-c9bb-fdb4602a71dc"
      },
      "execution_count": 15,
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": [
            "['Callable', 'DistributionWeightedMSE', 'EDGE_ATTR_BACKFILL_WARNED', 'F', 'GRAPH_DATA_PATH', 'GraphCollection', 'GraphSample', 'InterfaceGNN', 'METRICS_PATH', 'Path', 'SCALER_PATH', 'SUBPROJECT_ROOT', 'Sequence', 'StandardScaler', '__builtins__', '__cached__', '__doc__', '__file__', '__loader__', '__name__', '__package__', '__spec__', 'annotations', 'argparse', 'build_loss_fn', 'collect_grad_stats', 'evaluate', 'joblib', 'json', 'main', 'mean_absolute_error', 'mean_squared_error', 'nn', 'np', 'overfit_debug_run', 'parse_arguments', 'pd', 'pickle', 'plot_training_curves', 'plt', 'r2_score', 'standardize_dataset_targets', 'torch', 'train_epoch', 'ultra_minimal_probe']\n"
          ]
        }
      ]
    },
    {
      "cell_type": "code",
      "source": [
        "from src.gnn.train_gnn import GraphCollection, GRAPH_DATA_PATH\n",
        "\n",
        "ds = GraphCollection(GRAPH_DATA_PATH)\n",
        "print(f\"Loaded {len(ds.graphs)} graphs\")"
      ],
      "metadata": {
        "colab": {
          "base_uri": "https://localhost:8080/"
        },
        "id": "6-5Q0441gxxX",
        "outputId": "e21f088b-aeb6-465d-8875-817dbeaffc0c"
      },
      "execution_count": 16,
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": [
            "Loaded 1071 graphs\n"
          ]
        }
      ]
    },
    {
      "cell_type": "code",
      "source": [
        "from src.gnn.train_gnn import GraphCollection, GRAPH_DATA_PATH, InterfaceGNN\n",
        "import torch\n",
        "\n",
        "device = torch.device('cuda')\n",
        "print(\"Device:\", device)\n",
        "\n",
        "ds = GraphCollection(GRAPH_DATA_PATH)\n",
        "graphs = ds.graphs[:10]\n",
        "g0 = graphs[0]\n",
        "\n",
        "model = InterfaceGNN(\n",
        "    input_dim=g0.x.shape[1],\n",
        "    edge_attr_dim=g0.edge_attr.shape[1],\n",
        "    hidden_dim=128,\n",
        "    layers=3,\n",
        "    dropout=0.0,\n",
        "    use_norm=False\n",
        ").to(device)\n",
        "\n",
        "optimizer = torch.optim.Adam(model.parameters(), lr=1e-3, weight_decay=1e-4)\n",
        "\n",
        "print('=== 10-Graph Memorization Test (GPU) ===')\n",
        "for epoch in range(30):\n",
        "    epoch_losses = []\n",
        "    for g in graphs:\n",
        "        # déplacer chaque tenseur sur le GPU\n",
        "        x = g.x.to(device)\n",
        "        edge_index = g.edge_index.to(device)\n",
        "        edge_attr = g.edge_attr.to(device)\n",
        "        y = g.y.to(device)\n",
        "\n",
        "        edge_weight = torch.ones(edge_index.shape[1], device=device)\n",
        "\n",
        "        optimizer.zero_grad()\n",
        "        pred = model(x, edge_index, edge_weight, edge_attr)\n",
        "        loss = torch.nn.functional.mse_loss(pred.squeeze(), y.squeeze())\n",
        "        loss.backward()\n",
        "        torch.nn.utils.clip_grad_norm_(model.parameters(), max_norm=0.5)\n",
        "        optimizer.step()\n",
        "        epoch_losses.append(loss.item())\n",
        "\n",
        "    avg_loss = sum(epoch_losses) / len(epoch_losses)\n",
        "    print(f'Epoch {epoch}: avg={avg_loss:.4f}')\n",
        "\n",
        "    if avg_loss < 0.1:\n",
        "        print(f'✓ Memorization achieved at epoch {epoch}!')\n",
        "        break\n",
        "\n",
        "print(f'Final MSE: {avg_loss:.4f}')\n"
      ],
      "metadata": {
        "colab": {
          "base_uri": "https://localhost:8080/"
        },
        "id": "jqdHHnYthRq_",
        "outputId": "0fbc905f-f610-43bf-b717-cd44d7a9ef37"
      },
      "execution_count": 22,
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": [
            "Device: cuda\n",
            "=== 10-Graph Memorization Test (GPU) ===\n",
            "Epoch 0: avg=1.9356\n",
            "Epoch 1: avg=0.9999\n",
            "Epoch 2: avg=0.8589\n",
            "Epoch 3: avg=0.9106\n",
            "Epoch 4: avg=0.9922\n",
            "Epoch 5: avg=0.9280\n",
            "Epoch 6: avg=0.8909\n",
            "Epoch 7: avg=0.9373\n",
            "Epoch 8: avg=0.8719\n",
            "Epoch 9: avg=0.9193\n",
            "Epoch 10: avg=0.8593\n",
            "Epoch 11: avg=0.9069\n",
            "Epoch 12: avg=0.8355\n",
            "Epoch 13: avg=0.9077\n",
            "Epoch 14: avg=0.8349\n",
            "Epoch 15: avg=0.8575\n",
            "Epoch 16: avg=0.7671\n",
            "Epoch 17: avg=0.9093\n",
            "Epoch 18: avg=0.7783\n",
            "Epoch 19: avg=0.8249\n",
            "Epoch 20: avg=0.6967\n",
            "Epoch 21: avg=0.9153\n",
            "Epoch 22: avg=0.6252\n",
            "Epoch 23: avg=0.6167\n",
            "Epoch 24: avg=0.9104\n",
            "Epoch 25: avg=0.6444\n",
            "Epoch 26: avg=0.6419\n",
            "Epoch 27: avg=0.7648\n",
            "Epoch 28: avg=0.5779\n",
            "Epoch 29: avg=0.6898\n",
            "Final MSE: 0.6898\n"
          ]
        }
      ]
    },
    {
      "cell_type": "code",
      "source": [
        "from src.gnn.train_gnn import InterfaceGNN\n",
        "import inspect\n",
        "\n",
        "print(inspect.signature(InterfaceGNN))\n",
        "print(\"\\nSource:\")\n",
        "print(inspect.getsource(InterfaceGNN))\n"
      ],
      "metadata": {
        "colab": {
          "base_uri": "https://localhost:8080/"
        },
        "id": "4MuZWGdRlMlM",
        "outputId": "d56af8fd-710e-4c38-94d6-1e17e23694a2"
      },
      "execution_count": 20,
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": [
            "(input_dim: 'int', edge_attr_dim: 'int', hidden_dim: 'int' = 256, layers: 'int' = 6, dropout: 'float' = 0.2, use_norm: 'bool' = False)\n",
            "\n",
            "Source:\n",
            "class InterfaceGNN(nn.Module):\n",
            "    def __init__(\n",
            "        self,\n",
            "        input_dim: int,\n",
            "        edge_attr_dim: int,\n",
            "        hidden_dim: int = 256,\n",
            "        layers: int = 6,\n",
            "        dropout: float = 0.2,\n",
            "        use_norm: bool = False,\n",
            "    ):\n",
            "        super().__init__()\n",
            "        self.input_proj = nn.Linear(input_dim, hidden_dim)\n",
            "        self.layers = layers\n",
            "        self.dropout = nn.Dropout(p=dropout)\n",
            "\n",
            "        self.edge_mlps = nn.ModuleList(\n",
            "            [\n",
            "                nn.Sequential(\n",
            "                    nn.Linear(edge_attr_dim, hidden_dim),\n",
            "                    nn.ReLU(),\n",
            "                    nn.Linear(hidden_dim, hidden_dim),\n",
            "                )\n",
            "                for _ in range(layers)\n",
            "            ]\n",
            "        )\n",
            "        self.att_src = nn.ModuleList(\n",
            "            [nn.Linear(hidden_dim, hidden_dim) for _ in range(layers)]\n",
            "        )\n",
            "        self.att_dst = nn.ModuleList(\n",
            "            [nn.Linear(hidden_dim, hidden_dim) for _ in range(layers)]\n",
            "        )\n",
            "        self.msg_lin = nn.ModuleList(\n",
            "            [nn.Linear(hidden_dim, hidden_dim) for _ in range(layers)]\n",
            "        )\n",
            "        self.res_lin = nn.ModuleList(\n",
            "            [nn.Linear(hidden_dim, hidden_dim) for _ in range(layers)]\n",
            "        )\n",
            "        if use_norm:\n",
            "            self.norms = nn.ModuleList([nn.LayerNorm(hidden_dim) for _ in range(layers)])\n",
            "        else:\n",
            "            self.norms = nn.ModuleList([nn.Identity() for _ in range(layers)])\n",
            "        self.readout = nn.Linear(hidden_dim, 1)\n",
            "        self._init_weights()\n",
            "\n",
            "    def _init_weights(self) -> None:\n",
            "        \"\"\"\n",
            "        Kaiming initialization for stability with ReLU activations.\n",
            "        \"\"\"\n",
            "        for module in self.modules():\n",
            "            if isinstance(module, nn.Linear):\n",
            "                if module is self.readout:\n",
            "                    nn.init.normal_(module.weight, mean=0.0, std=0.01)\n",
            "                    if module.bias is not None:\n",
            "                        nn.init.constant_(module.bias, 0.0)\n",
            "                else:\n",
            "                    nn.init.kaiming_normal_(module.weight, mode=\"fan_in\", nonlinearity=\"relu\")\n",
            "                    if module.bias is not None:\n",
            "                        nn.init.constant_(module.bias, 0.0)\n",
            "\n",
            "    def forward(\n",
            "        self,\n",
            "        x: torch.Tensor,\n",
            "        edge_index: torch.Tensor,\n",
            "        edge_weight: torch.Tensor,\n",
            "        edge_attr: torch.Tensor,\n",
            "    ) -> torch.Tensor:\n",
            "        # Clamp edge attributes and weights to control activation scale\n",
            "        edge_attr = torch.tanh(edge_attr)\n",
            "        edge_weight = torch.clamp(edge_weight, min=0.0, max=1.0)\n",
            "\n",
            "        h = self.input_proj(x)\n",
            "        for idx in range(self.layers):\n",
            "            h_act = F.relu(h)\n",
            "            src = h_act[edge_index[0]]\n",
            "            dst = h_act[edge_index[1]]\n",
            "            bias = self.edge_mlps[idx](edge_attr)\n",
            "            att = torch.sigmoid(\n",
            "                (self.att_src[idx](src) + self.att_dst[idx](dst) + bias).sum(dim=1, keepdim=True)\n",
            "            )\n",
            "            weight = edge_weight.unsqueeze(-1)\n",
            "            msg = self.msg_lin[idx](src) * att * weight\n",
            "            agg = torch.zeros_like(h_act)\n",
            "            agg = agg.index_add(0, edge_index[1], msg)\n",
            "            updated = self.res_lin[idx](h_act + agg)\n",
            "            updated = self.dropout(F.relu(updated))\n",
            "            h = self.norms[idx](updated)\n",
            "        graph_rep = h.mean(dim=0)\n",
            "        # Scale down the final output to avoid huge initial predictions\n",
            "        return (self.readout(graph_rep) / 50.0).squeeze(-1)\n",
            "\n"
          ]
        }
      ]
    },
    {
      "cell_type": "code",
      "source": [
        "!python -m src.gnn.train_gnn \\\n",
        "  --hidden-dim 128 \\\n",
        "  --layers 3 \\\n",
        "  --dropout 0.2 \\\n",
        "  --lr 1e-3 \\\n",
        "  --epochs 80 \\\n",
        "  --patience 20 \\\n",
        "  --standardize-targets \\\n",
        "  --loss-type dist_weighted\n"
      ],
      "metadata": {
        "colab": {
          "base_uri": "https://localhost:8080/"
        },
        "id": "n9ZY7F6Joe-S",
        "outputId": "db190a9f-7b49-441a-97fb-3feee10d8e3f"
      },
      "execution_count": 24,
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": [
            "[INFO] Saved target scaler to /content/structural-antibody-binding-gnn/3D-GNN-over-antibody-antigen/reports/ddg_scaler.pkl\n",
            "Traceback (most recent call last):\n",
            "  File \"<frozen runpy>\", line 198, in _run_module_as_main\n",
            "  File \"<frozen runpy>\", line 88, in _run_code\n",
            "  File \"/content/structural-antibody-binding-gnn/src/gnn/train_gnn.py\", line 597, in <module>\n",
            "    main()\n",
            "  File \"/content/structural-antibody-binding-gnn/src/gnn/train_gnn.py\", line 526, in main\n",
            "    metrics = evaluate(model, dataset.get_split(split), scaler=scaler)\n",
            "              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n",
            "  File \"/content/structural-antibody-binding-gnn/src/gnn/train_gnn.py\", line 234, in evaluate\n",
            "    rmse = mean_squared_error(truths_arr, preds_arr, squared=False)\n",
            "           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n",
            "  File \"/usr/local/lib/python3.12/dist-packages/sklearn/utils/_param_validation.py\", line 194, in wrapper\n",
            "    params = func_sig.bind(*args, **kwargs)\n",
            "             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n",
            "  File \"/usr/lib/python3.12/inspect.py\", line 3280, in bind\n",
            "    return self._bind(args, kwargs)\n",
            "           ^^^^^^^^^^^^^^^^^^^^^^^^\n",
            "  File \"/usr/lib/python3.12/inspect.py\", line 3269, in _bind\n",
            "    raise TypeError(\n",
            "TypeError: got an unexpected keyword argument 'squared'\n"
          ]
        }
      ]
    },
    {
      "cell_type": "code",
      "source": [
        "import io, pathlib\n",
        "\n",
        "path = pathlib.Path(\"src/gnn/train_gnn.py\")\n",
        "text = path.read_text()\n",
        "\n",
        "text = text.replace(\n",
        "    \"rmse = mean_squared_error(truths_arr, preds_arr, squared=False)\",\n",
        "    \"import numpy as np\\n    mse = mean_squared_error(truths_arr, preds_arr)\\n    rmse = np.sqrt(mse)\"\n",
        ")\n",
        "\n",
        "path.write_text(text)\n",
        "print(\"Patched train_gnn.py\")\n"
      ],
      "metadata": {
        "colab": {
          "base_uri": "https://localhost:8080/"
        },
        "id": "cvEclrQ6qLfe",
        "outputId": "6d383c73-225c-46d4-a0ed-92225adf806f"
      },
      "execution_count": 25,
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": [
            "Patched train_gnn.py\n"
          ]
        }
      ]
    },
    {
      "cell_type": "code",
      "source": [
        "import pathlib\n",
        "\n",
        "path = pathlib.Path(\"src/gnn/train_gnn.py\")\n",
        "text = path.read_text()\n",
        "\n",
        "# Enlève d'éventuels imports numpy mal indentés\n",
        "text = text.replace(\"    import numpy as np\\n\", \"\")\n",
        "\n",
        "# Ajoute un import global juste après la première ligne \"import torch\"\n",
        "if \"import numpy as np\" not in text:\n",
        "    text = text.replace(\"import torch\\n\", \"import torch\\nimport numpy as np\\n\")\n",
        "\n",
        "path.write_text(text)\n",
        "print(\"Patched train_gnn.py with global 'import numpy as np'\")\n"
      ],
      "metadata": {
        "colab": {
          "base_uri": "https://localhost:8080/"
        },
        "id": "a-ZdOSwFqaRl",
        "outputId": "11d998fe-ac71-46b4-ace0-806e8ec51124"
      },
      "execution_count": 30,
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": [
            "Patched train_gnn.py with global 'import numpy as np'\n"
          ]
        }
      ]
    },
    {
      "cell_type": "code",
      "source": [
        "!head -n 20 src/gnn/train_gnn.py\n"
      ],
      "metadata": {
        "colab": {
          "base_uri": "https://localhost:8080/"
        },
        "id": "-alt_q8zqqPX",
        "outputId": "4cc40abd-01a2-450b-9a2f-758266c1e2c3"
      },
      "execution_count": 31,
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": [
            "#!/usr/bin/env python\n",
            "from __future__ import annotations\n",
            "\n",
            "import argparse\n",
            "import json\n",
            "import pickle\n",
            "from pathlib import Path\n",
            "from typing import Sequence, Callable\n",
            "\n",
            "import numpy as np\n",
            "import pandas as pd\n",
            "import torch\n",
            "import torch.nn as nn\n",
            "import torch.nn.functional as F\n",
            "import matplotlib.pyplot as plt\n",
            "from sklearn.metrics import mean_absolute_error, mean_squared_error, r2_score\n",
            "from sklearn.preprocessing import StandardScaler\n",
            "import joblib\n",
            "\n",
            "from src.data.structure_utils import SUBPROJECT_ROOT\n"
          ]
        }
      ]
    },
    {
      "cell_type": "code",
      "source": [
        "import inspect\n",
        "from src.gnn import train_gnn as tg\n",
        "print(inspect.getsource(tg.evaluate))\n"
      ],
      "metadata": {
        "colab": {
          "base_uri": "https://localhost:8080/"
        },
        "id": "LC0wlJIgqry5",
        "outputId": "5fc18f53-c162-46fb-f1e2-80d0ac511ca4"
      },
      "execution_count": 33,
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": [
            "def evaluate(\n",
            "    model: nn.Module,\n",
            "    graphs: Sequence[GraphSample],\n",
            "    scaler: StandardScaler | None = None,\n",
            ") -> dict[str, float]:\n",
            "    model.eval()\n",
            "    truths: list[float] = []\n",
            "    preds: list[float] = []\n",
            "    with torch.no_grad():\n",
            "        for graph in graphs:\n",
            "            output = model(\n",
            "                graph.x, graph.edge_index, graph.edge_weight, graph.edge_attr\n",
            "            )\n",
            "            preds.append(float(output.item()))\n",
            "            truths.append(float(graph.y.item()))\n",
            "    if not truths:\n",
            "        return {\"mae\": float(\"nan\"), \"rmse\": float(\"nan\"), \"r2\": float(\"nan\")}\n",
            "    preds_arr = np.array(preds)\n",
            "    truths_arr = np.array(truths)\n",
            "    if scaler is not None:\n",
            "        preds_arr = scaler.inverse_transform(preds_arr.reshape(-1, 1)).flatten()\n",
            "        truths_arr = scaler.inverse_transform(truths_arr.reshape(-1, 1)).flatten()\n",
            "    mae = mean_absolute_error(truths_arr, preds_arr)\n",
            "    mse = mean_squared_error(truths_arr, preds_arr)\n",
            "    rmse = np.sqrt(mse)\n",
            "    r2 = r2_score(truths_arr, preds_arr)\n",
            "    return {\"mae\": mae, \"rmse\": rmse, \"r2\": r2}\n",
            "\n"
          ]
        }
      ]
    },
    {
      "cell_type": "code",
      "source": [
        "!python -m src.gnn.train_gnn \\\n",
        "  --hidden-dim 128 \\\n",
        "  --layers 3 \\\n",
        "  --dropout 0.2 \\\n",
        "  --lr 1e-3 \\\n",
        "  --epochs 80 \\\n",
        "  --patience 20 \\\n",
        "  --standardize-targets \\\n",
        "  --loss-type dist_weighted\n"
      ],
      "metadata": {
        "colab": {
          "base_uri": "https://localhost:8080/"
        },
        "id": "qh8CrWhbrWIn",
        "outputId": "25d71530-1cc5-406e-a780-043bcf08eb1e"
      },
      "execution_count": 34,
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": [
            "[INFO] Saved target scaler to /content/structural-antibody-binding-gnn/3D-GNN-over-antibody-antigen/reports/ddg_scaler.pkl\n",
            "[epoch 1] loss=0.280 val_mae=1.996 val_r2=-0.705\n",
            "[epoch 2] loss=0.260 val_mae=1.866 val_r2=-0.382\n",
            "[epoch 3] loss=0.248 val_mae=2.079 val_r2=-0.670\n",
            "[epoch 4] loss=0.298 val_mae=1.414 val_r2=0.063\n",
            "[epoch 5] loss=0.263 val_mae=1.760 val_r2=-0.247\n",
            "[epoch 6] loss=0.220 val_mae=2.024 val_r2=-0.632\n",
            "[epoch 7] loss=0.220 val_mae=1.777 val_r2=-0.357\n",
            "[epoch 8] loss=0.288 val_mae=1.406 val_r2=0.045\n",
            "[epoch 9] loss=0.252 val_mae=1.468 val_r2=-0.043\n",
            "[epoch 10] loss=0.220 val_mae=1.803 val_r2=-0.255\n",
            "[epoch 11] loss=0.212 val_mae=1.488 val_r2=0.028\n",
            "[epoch 12] loss=0.217 val_mae=2.383 val_r2=-0.861\n",
            "[epoch 13] loss=0.199 val_mae=1.640 val_r2=-0.025\n",
            "[epoch 14] loss=0.197 val_mae=1.802 val_r2=-0.146\n",
            "[epoch 15] loss=0.344 val_mae=1.519 val_r2=-0.088\n",
            "[epoch 16] loss=0.200 val_mae=1.574 val_r2=0.073\n",
            "[epoch 17] loss=0.234 val_mae=1.497 val_r2=0.108\n",
            "[epoch 18] loss=0.213 val_mae=1.702 val_r2=-0.075\n",
            "[epoch 19] loss=0.196 val_mae=1.476 val_r2=0.057\n",
            "[epoch 20] loss=0.190 val_mae=1.577 val_r2=0.053\n",
            "[epoch 21] loss=0.194 val_mae=1.600 val_r2=-0.072\n",
            "[epoch 22] loss=0.204 val_mae=1.651 val_r2=-0.043\n",
            "[epoch 23] loss=0.191 val_mae=1.699 val_r2=-0.168\n",
            "[epoch 24] loss=0.209 val_mae=1.433 val_r2=0.136\n",
            "[epoch 25] loss=0.177 val_mae=1.628 val_r2=-0.037\n",
            "[epoch 26] loss=0.190 val_mae=1.577 val_r2=0.021\n",
            "[epoch 27] loss=0.196 val_mae=1.609 val_r2=-0.058\n",
            "[epoch 28] loss=0.183 val_mae=1.778 val_r2=-0.221\n",
            "[epoch 29] loss=0.195 val_mae=1.506 val_r2=0.020\n",
            "[epoch 30] loss=0.189 val_mae=1.731 val_r2=-0.120\n",
            "[epoch 31] loss=0.232 val_mae=1.660 val_r2=-0.146\n",
            "[epoch 32] loss=0.181 val_mae=1.728 val_r2=-0.123\n",
            "Traceback (most recent call last):\n",
            "  File \"<frozen runpy>\", line 198, in _run_module_as_main\n",
            "  File \"<frozen runpy>\", line 88, in _run_code\n",
            "  File \"/content/structural-antibody-binding-gnn/src/gnn/train_gnn.py\", line 598, in <module>\n",
            "    main()\n",
            "  File \"/content/structural-antibody-binding-gnn/src/gnn/train_gnn.py\", line 517, in main\n",
            "    train_loss, grad_stats = train_epoch(\n",
            "                             ^^^^^^^^^^^^\n",
            "  File \"/content/structural-antibody-binding-gnn/src/gnn/train_gnn.py\", line 201, in train_epoch\n",
            "    loss.backward()\n",
            "  File \"/usr/local/lib/python3.12/dist-packages/torch/_tensor.py\", line 625, in backward\n",
            "    torch.autograd.backward(\n",
            "  File \"/usr/local/lib/python3.12/dist-packages/torch/autograd/__init__.py\", line 354, in backward\n",
            "    _engine_run_backward(\n",
            "  File \"/usr/local/lib/python3.12/dist-packages/torch/autograd/graph.py\", line 841, in _engine_run_backward\n",
            "    return Variable._execution_engine.run_backward(  # Calls into the C++ engine to run the backward pass\n",
            "           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n",
            "KeyboardInterrupt\n"
          ]
        }
      ]
    },
    {
      "cell_type": "code",
      "source": [
        "import pandas as pd\n",
        "metrics = pd.read_csv(\"3D-GNN-over-antibody-antigen/reports/gnn_metrics.csv\")\n",
        "print(metrics.tail())\n"
      ],
      "metadata": {
        "colab": {
          "base_uri": "https://localhost:8080/"
        },
        "id": "mtJnRHl-s6JG",
        "outputId": "5983d980-4175-4048-c58c-33ee301e9bbb"
      },
      "execution_count": 35,
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": [
            "   epoch  train_loss  train_mae  train_rmse  train_r2   val_mae  val_rmse  \\\n",
            "1      2    4.851874   1.736639    2.634030 -0.296600  1.468465  2.350846   \n",
            "2      3    5.028009   1.831001    2.740127 -0.403156  1.553637  2.443023   \n",
            "3      4    5.098525   1.959280    2.858423 -0.526925  1.682066  2.549750   \n",
            "4      5    5.226903   1.619910    2.430217 -0.103709  1.415554  2.193212   \n",
            "5      6    5.355857   1.614175    2.414236 -0.089241  1.420033  2.183078   \n",
            "\n",
            "     val_r2  test_mae  test_rmse   test_r2  is_best_epoch  \n",
            "1 -0.196701  0.857807   1.339718 -0.417881           True  \n",
            "2 -0.292387  0.992773   1.463810 -0.692711          False  \n",
            "3 -0.407774  1.172955   1.606588 -1.039023          False  \n",
            "4 -0.041595  0.735494   1.144983 -0.035646           True  \n",
            "5 -0.031991  0.743075   1.136216 -0.019847           True  \n"
          ]
        }
      ]
    }
  ],
  "metadata": {
    "colab": {
      "name": "Bienvenue dans Colab",
      "provenance": [],
      "gpuType": "T4",
      "include_colab_link": true
    },
    "kernelspec": {
      "display_name": "Python 3",
      "name": "python3"
    },
    "accelerator": "GPU"
  },
  "nbformat": 4,
  "nbformat_minor": 0
}